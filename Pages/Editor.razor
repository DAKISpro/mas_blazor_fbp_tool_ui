@page "/"
@page "/editor"
@namespace BlazorDrawFBP.Pages

@inject Mas.Infrastructure.Common.ConnectionManager ConMan
@inject Shared Shared
@inject Blazored.LocalStorage.ILocalStorageService LocalStorage
@inject IJSRuntime JsRuntime

@using System.Collections.Immutable
@using Blazor.Diagrams.Components.Widgets
@using BlazorDrawFBP.Models
@using Newtonsoft.Json.Linq
@using MudBlazor
@using System.Timers
@using Mas.Schema.Fbp

<div>
    <MudGrid>
        <MudItem xs="2">
            <MudPaper Height="90vh" Class="overflow-scroll">
                <MudExpansionPanels MultiExpansion="true">
                    <MudExpansionPanel Text="Actions" Expanded="true">
                        <MudStack Spacing="1">
                            @* <MudButton StartIcon="@Icons.Material.Filled.Delete" *@
                            @*            Variant="@Variant.Filled" *@
                            @*            Color="@Color.Warning" *@
                            @*            FullWidth="true" *@
                            @*            @onclick="RemoveNode"> *@
                            @*     Remove Node *@
                            @* </MudButton> *@
                            <MudFileUpload T="IBrowserFile"
                                           FilesChanged="LoadFlow"
                                           Style="margin-top:0;">
                                <ActivatorContent>
                                    <MudButton StartIcon="@Icons.Material.Filled.Upload"
                                               Variant="@Variant.Filled"
                                               Color="@Color.Primary"
                                               FullWidth="true">
                                        Load Flow
                                    </MudButton>
                                </ActivatorContent>
                            </MudFileUpload>
                            <MudButton StartIcon="@Icons.Material.Filled.Download"
                                       Variant="@Variant.Filled"
                                       Color="@Color.Primary"
                                       FullWidth="true"
                                       @onclick="() => SaveFlow(false)">
                                Save Flow
                            </MudButton>
                            <MudButton StartIcon="@Icons.Material.Filled.Download"
                                       Variant="@Variant.Filled"
                                       Color="@Color.Primary"
                                       FullWidth="true"
                                       @onclick="() => SaveFlow(true)">
                                Export as Mermaid Flow
                            </MudButton>
                            <MudButton
                                StartIcon="@(ClearButtonDisabled ? Icons.Material.Filled.Delete : Icons.Material.Filled.DeleteForever)"
                                Variant="@Variant.Filled"
                                Color="@(ClearButtonDisabled ? Color.Warning : Color.Error)"
                                FullWidth="true"
                                OnClick="ClearButtonClicked">
                                @(ClearButtonDisabled ? "Clear Flow" : "Clear Flow")
                            </MudButton>
                            <MudButton StartIcon="@Icons.Material.Filled.PlayCircle"
                                       Variant="@Variant.Filled"
                                       Color="@Color.Default"
                                       FullWidth="true"
                                       @onclick="@ExecuteFlow">
                                Execute flow
                            </MudButton>
                        </MudStack>
                    </MudExpansionPanel>
                    <MudSwitch @bind-Value="@InteractiveMode"
                               Label="Interactive"
                               Color="Color.Success"
                               Style="padding-left: 10px"/>
                    <MudTextField @bind-Value="@_query"
                                  Label="Search component ..."
                                  Variant="Variant.Outlined"
                                  Margin="Margin.Dense"
                                  Adornment="Adornment.End"
                                  AdornmentIcon="@Icons.Material.Filled.Cancel"
                                  OnAdornmentClick="() => { _query = null; }"/>
                    @foreach (var catId in sortedCatIds)
                    {
                        var compIds = Shared.CatId2ComponentIds[catId];
                        <MudExpansionPanel Text="@(Shared.CatId2Info[catId].Name)"
                                           Expanded="@(!string.IsNullOrWhiteSpace(_query)
                                                     || _expandedPanels.GetValueOrDefault(catId, false))"
                                           ExpandedChanged="b => { if (string.IsNullOrWhiteSpace(_query)) _expandedPanels[catId] = b; }">
                            <MudStack Spacing="1">
                                @foreach (var compId in compIds)
                                {
                                    var comp = Shared.ComponentId2Component[compId];
                                    if (comp.Type == Component.ComponentType.subflow) continue;
                                    var desc = comp.Info.Description ?? "";

                                    if (!string.IsNullOrWhiteSpace(_query) &&
                                        comp.Info.Name?.Contains(_query, StringComparison.OrdinalIgnoreCase) == false &&
                                        desc.Contains(_query, StringComparison.OrdinalIgnoreCase) == false)
                                    {
                                        continue;
                                    }

                                    if (string.IsNullOrEmpty(comp.Info.Description))
                                    {
                                        <MudButton style="cursor: grab;"
                                                   draggable="true"
                                                   @ondragstart="() => OnNodeDragStart(comp)"
                                                   Variant="Variant.Filled"
                                                   StartIcon="@Icons.Material.Filled.DragIndicator"
                                                   IconColor="Color.Primary"
                                                   Color="Color.Default"
                                                   FullWidth="true"
                                                   Size="Size.Large">
                                            @comp.Info.Name
                                        </MudButton>
                                    }
                                    else
                                    {
                                        <MudTooltip>
                                            <ChildContent>
                                                <MudButton style="cursor: grab;"
                                                           draggable="true"
                                                           @ondragstart="() => OnNodeDragStart(comp)"
                                                           Variant="Variant.Filled"
                                                           StartIcon="@Icons.Material.Filled.DragIndicator"
                                                           IconColor="Color.Primary"
                                                           FullWidth="true"
                                                           Color="Color.Default">
                                                    @comp.Info.Name
                                                </MudButton>
                                            </ChildContent>
                                            <TooltipContent>
                                                <MudText Typo="Typo.body2">@comp.Info.Description</MudText>
                                            </TooltipContent>
                                        </MudTooltip>
                                    }
                                }
                            </MudStack>
                        </MudExpansionPanel>
                    }
                </MudExpansionPanels>
            </MudPaper>
        </MudItem>
        <MudItem xs="10">
            <MudPaper Outlined="true" class="diagram-container" ondragover="event.preventDefault();"
                      @ondrop="OnNodeDrop">
                <CascadingValue Value="Diagram" IsFixed="true">
                    <DiagramCanvas>
                        <Widgets>
                            <NavigatorWidget Width="200"
                                             Height="120"
                                             Class="border border-black bg-white absolute"
                                             Style="bottom: 15px; right: 15px;"/>
                        </Widgets>
                    </DiagramCanvas>
                </CascadingValue>
            </MudPaper>
        </MudItem>
    </MudGrid>
</div>

@code {
    private Timer ClearButtonTimer { get; set; }
    private bool ClearButtonDisabled { get; set; } = true;
    private Editor _editor;
    private string _query;
    private const string DefaultCatId = "default";
    private Dictionary<string, bool> _expandedPanels = new() { {DefaultCatId, true} };
    private bool _interactiveMode = false;
    private bool InteractiveMode { 
        get => _interactiveMode; 
        set { 
            _interactiveMode = value; 
            InteractiveModeChanged?.Invoke(value); 
        }
    }
    public event Action<bool> InteractiveModeChanged;

    private IEnumerable<(string, Component)> catId2Component =>
        Shared.CatId2ComponentIds.SelectMany(kv =>
            kv.Value.Select(compId => (kv.Key, compId))).Select(catIdCompId =>
                (catIdCompId.Key, Shared.ComponentId2Component[catIdCompId.compId]));

    private IEnumerable<string> sortedCatIds => new List<string> { DefaultCatId }
            .Concat(Shared.CatId2ComponentIds.Keys
            .Where(catId => catId != DefaultCatId)
            .ToImmutableSortedSet()
            .AsEnumerable());

    private void ClearButtonClicked()
    {
        if (ClearButtonDisabled)
        {
            if (ClearButtonTimer == null)
            {
                //Console.WriteLine("Creating new timer");
                _editor = this;
                ClearButtonTimer = new Timer(2000) { AutoReset = false };
                ClearButtonTimer.Elapsed += ClearButtonTimerElapsed;
            }
            ClearButtonTimer.Start();
            ClearButtonDisabled = false;
        }
        else
        {
            ClearDiagram();
            ClearButtonDisabled = true;
        }
    }

    private void ClearButtonTimerElapsed(object sender, ElapsedEventArgs e)
    {
        //Console.WriteLine("Timer elapsed");
        ClearButtonDisabled = true;
        _editor?.InvokeAsync(StateHasChanged);
    }
}